#!/usr/bin/env bash

set -uo pipefail

# Bump this counter (YYYYMMDD) to force rebuilding `dev` on all machines.
DEV_VERSION=20220107

THIS_DIR=$(cd "$(dirname "$0")" && pwd)
BINARY_DIR=$THIS_DIR/bin/dev-versions
BINARY_PATH=$BINARY_DIR/dev.$DEV_VERSION

if [ ! -f "$BINARY_PATH" ]; then
    echo "$BINARY_PATH not found, building..."
    mkdir -p $BINARY_DIR
    bazel build //pkg/cmd/dev --config nonogo
    cp $(bazel info bazel-bin --config nonogo)/pkg/cmd/dev/dev_/dev $BINARY_PATH

    # Previously we stage binaries in bin/dev. Install a shim script to make
    # sure we're on the same page.
    rm -f $THIS_DIR/bin/dev
    cat > $THIS_DIR/bin/dev <<EOF
#!/usr/bin/env bash

# Code generated by top-level 'dev' script; DO NOT EDIT.
${BINARY_PATH}
EOF
    chmod +x $THIS_DIR/bin/dev
fi

exec $BINARY_PATH "$@"
