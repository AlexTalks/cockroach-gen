# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO204Qxs_sU3zyheT_j4mT9ICMKtUEo7o1DnJcCkJotbaXZIvtjXbX1FBV4iHyhDxJZUMhh5a2B3wYaWa-36cZz9o2TrjSQlYupjK7UpJly4N98IZnaS2KnCsYrg2uH1SE2DYUlyrnin6RotK0EKUwWDINs-TI-SWrC4NrVtTcxZtWzyuWFpzeisUtW3TU7-SyavVyZUQpbrmil1JxsajoFb_RLzO8WXElSl4ZVtBfGtCM6Yzl_A9Gz2ytOV0KbeRCsfKfqLIujMhkQbVh5iWSTGPfS3wk3n7oo0GPbDEEUbKLaJYg-hSGA7KVPlYesuksmiexF0QJrJUSJVM3Fo7j4MiLz_DRP0OPwZtP-wOyFUQH_ikamlKRN-ilP-uH3lEQnm3gPTZA2if9PUK8MPHjx3naw--s6rQQ2U6DIPrgTxPMEy8J5kkwnWP7nADAty62n5XJoi4rbbk4fyp2DWY95ReDDb3izPCcMmO5sMbOaNd2RrYzgjNyHcd1nP-7aG0gudBGVJmhmayrFhs5zka7Oxht_725WfHWdROu6qJ4AjcxJb8-G44no_Gk630f_PWG6Stu2A30ekuSi-09QvzT49ALIvRmx8kAfnTSx9wP25P_h8N4doQGn9_7sY8UbzHZI7Zt20RnrELz7vGNEdyv1_fru_v1HTJZaaOYqIyL4Xg4cnE-nMDGcHJBfgQAAP__8JNGZA==

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO204Qxs_sU3zyheT_j4mT9ICMKtUEo7o1DnJcCkJotbaXZIvtjXbX1FBV4iHyhDxJZUMhh5a2B3wYaWa-36cZz9o2TrjSQlYupjK7UpJly4N98IZnaS2KnCsYrg2uH1SE2DYUlyrnin6RotK0EKUwWDINs-TI-SWrC4NrVtTcxZtWzyuWFpzeisUtW3TU7-SyavVyZUQpbrmil1JxsajoFb_RLzO8WXElSl4ZVtBfGtCM6Yzl_A9Gz2ytOV0KbeRCsfKfqLIujMhkQbVh5iWSTGPfS3wk3n7oo0GPbDEEUbKLaJYg-hSGA7KVPlYesuksmiexF0QJrJUSJVM3Fo7j4MiLz_DRP0OPwZtP-wOyFUQH_ikamlKRN-ilP-uH3lEQnm3gPTZA2if9PUK8MPHjx3naw--s6rQQ2U6DIPrgTxPMEy8J5kkwnWP7nADAty62n5XJoi4rbbk4fyp2DWY95ReDDb3izPCcMmO5sMbOaNd2RrYzgjNyHcd1nP-7aG0gudBGVJmhmayrFhs5zka7Oxht_725WfHWdROu6qJ4AjcxJb8-G44no_Gk630f_PWG6Stu2A30ekuSi-09QvzT49ALIvRmx8kAfnTSx9wP25P_h8N4doQGn9_7sY8UbzHZI7Zt20RnrELz7vGNEdyv1_fru_v1HTJZaaOYqIyL4Xg4cnE-nMDGcHJBfgQAAP__8JNGZA==

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lM9um04Qx8_ZpxhxCf79IMZ2DxFRpRJn3dI6OMI0TRRFqwWv7W0wWLsLhVSVoj6Dj306P0kFdhLU_GlzCIeVdub7Gc0wXzBNOGVC8jSxoZ9GVyKl0fzoEFjBojDj8YQJUEwqyDcqhEwTBEvFhAnyNeWJJDFfcAVzKkHNGUzYlGaxgpzGGbPhTaVnCQ1jRq757JrOauopeZpU-nSp-IJfM0GmqWB8lpArVsrnGVYsmeALligak0cLkIjKiE7YXwrds5lkZM6lSmeCLl5ELbJY8SiNiVRUPUeivo-dAEPgHA4xFKCjHQquF-yDNwrA-zwcGmgn3EY2t_7IGwe-43oBaEvBF1SUGpz47rHjn8MnfA46BWfcbxlox_WO8BkUJCR8UoAe3sYHzrE7PG_gOjUgbKHWAULOMMD-tp9q8XvLLIx5tFeA633E_QDGgRO448Dtj2H3AgEAfK_P6tGiNM4WidRsuLgL1gmq3d0vjYZeMKrYhFCl2aB1rc6-aXVMqwNWx7Ys27L-r0-tgUy4VDyJFInSLKmwjmU10vXCSPXuVblkVdUmnGRxfAc2MZF-uy_Y7XW6vTr3w_jnCcNXnLBu6PWGRJe7B39YsaysmD2wYv5CK2a3lmtIp1ckJ4JNSQGDkY_d995Gm7fAxwPsY6-Px1Do9N7CJck3Fs6ftnBmQP68hctHLVzPjs9Oho7rgT46CQzA3mkLxnhYaf-DgT86hsKAEr58wD6GEN5C7wCZpmkiniRMmPUfTY9EKmULwXr1a726Wa9uQEY0gfJBpHi3_SSrzM9qA-vVaiuI0kQqQXmibGh32x0bLto9MKHdu0QN2ZTHigkJuhIZa6HfAQAA__8GL664

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k9FOnEAUhq-dpzjhRrYFw2ovzHqFKya0yJqFGo0xkwGOu1OHmc3MoGjTxIfYyz6dT9KAVkna2vZCLibMf_7vzzmc4PtwgtpwJScwVeWVVqxcHuwDtlgWDRcVarBoLFw_ugjxfdCodIWaflFcGip4zS0smQG7RKjwkjXCwjUTDU7gQ-dHyQqB9I4v7tiip_5kV7Lzq5XlNb9DTS-VRr6Q9ApvzesMtivUvEZpmaC_DaAlMyWr8C9BL2xjkC65sWqhWf1fVN0Iy0slqLHMvkaS6TwK8wjycD-JoAWXbDCI03wX0lkO6eck8chG8aQ83qazNMvnYZzm4Kw0r5m-deB4Hh-F8zP4FJ2ByyDMpiOPbMTpQXQKLS0or1pwi5_6YXgUJ2cD3GUeFCMy2iMkTPJo_tRPt_itVVMIXm61EKcfo2kOWR7mcZbH0ww2zwkAwNf-7B6nVKKppXEmcP4s9gXmPN8vvIFfI7NYUWadCTjbwXjXD8Z-MIZgPAmCSRC8709ngFTcWC5LS0vVyA4bB8Gg3C-Mdt_e3q6wSx3CshHiGRxiWt28BG7vjLd3-to3758nLN5wwr6htxuSXGzuERKdHidhnII7O849iNKTEWRR0q38HRzOZ0fQQpiBkug9vtkbtUd83_cJlxK13__XbqmVMSMCD-vvD-v7h_U9mJLJDvtFszeq09ZP2iUXFrUB1-oGR-RHAAAA___HploW

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 100

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9u2jAUh6_rp_ipNw1T0z9iFxOoF2lqtmwhoMTriqrKMsGARxIj24kIV30InpAnmRid9kdTp13a-r7v6EjH93EvjVW66iHU-cpokS_vbiE3Mp_WqphJAyetQ3OkCMkog5HazKThX7WqLC9UqRxucH111Qd8HzM5F3Xh0Iiilj28Jb4PWYlpIflWLbZi8V3EUli4pfwT19WB12unSrWVhs-1kWpR8ZVs7euO3KylUaWsnCj4XwM8FzYXM_mP0E-3tpIvlXV6YUT5X1ZZF07luuDWCfeaScKUBoyCBbcxRQuPnNSIEvYOyYgh-RzH5-Skefk5vsJRkrE0iBKG07VRpTDtKcZpNAzSCT7RCbwaQRZ2fkfnK95wI-d8g8EopdH75Mg2HaR0QFOahDTDxhMHL0ru6ANa3nA128BrfvQGwTCKJ7-M9epzNB3S6RMSxIymL3scjuZiXU8LlV-0iJKPNGTIWMCijEVhhrPHp7M-IfRhHAdRAm80ZuegyX0HGY0P7BsM0tEQLb58oClFjRt0-8T3fZ_YXFRoCfa73X73vN89I9eVdUaoyvVwed3D42UXPi67T-RbAAAA__80vOxI

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 100


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt9u2jAUh6_rp_ipNw1T0z9iFxOoF2lqtmwhoMTriqrKMsGARxIj24kIV30InpAnmRid9kdTp13a-r7v6EjH93EvjVW66iHU-cpokS_vbiE3Mp_WqphJAyetQ3OkCMkog5HazKThX7WqLC9UqRxucH111Qd8HzM5F3Xh0Iiilj28Jb4PWYlpIflWLbZi8V3EUli4pfwT19WB12unSrWVhs-1kWpR8ZVs7euO3KylUaWsnCj4XwM8FzYXM_mP0E-3tpIvlXV6YUT5X1ZZF07luuDWCfeaScKUBoyCBbcxRQuPnNSIEvYOyYgh-RzH5-Skefk5vsJRkrE0iBKG07VRpTDtKcZpNAzSCT7RCbwaQRZ2fkfnK95wI-d8g8EopdH75Mg2HaR0QFOahDTDxhMHL0ru6ANa3nA128BrfvQGwTCKJ7-M9epzNB3S6RMSxIymL3scjuZiXU8LlV-0iJKPNGTIWMCijEVhhrPHp7M-IfRhHAdRAm80ZuegyX0HGY0P7BsM0tEQLb58oClFjRt0-8T3fZ_YXFRoCfa73X73vN89I9eVdUaoyvVwed3D42UXPi67T-RbAAAA__80vOxI

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0t9u2jAUBvDr-ik-9aZhavpH7GICcZGmZssWAkq8rqiqLBMc8Ehi5DgR4aoPwRPyJBOl0zYJbdqlre_3HR3puC4epKmULnvwdboyWqTL-zvIjUxntcrn0sDKyqI5pghJKIOR2syl4d-1Kiueq0JZDHB7c9MHXBdzmYk6t2hEXsse3r8aWYpZLvlWLbZi8SoxgM6yk0SXxHWh11YVaisNz7SRalHylWwrLEUFu5SnjdyspVGFLK3I-ckCnooqFXP5j6Jftq4kX6rK6oURxX-pos6tSnXOKyvs3yTxY-oxCubdhRQtHHJWI4jYB0RjhuhrGF6Ss-bt5_jyx1HCYi-IGM7XRhXCtOeYxMHIi6f4QqdwaniJ3_kzmq14w43M-AbDcUyDj9Ex23QQ0yGNaeTTBBtHHFwQ3dNHtLzhar6B0_zsG3qjIJz-NtapL9F0SKdPiBcyGr_tcTicq3U9y1V61SKIPlOfIWEeCxIW-Akunp4v-oTQx0noBRGc8YRdgkYPHSQ0PGTfYRiPR2jx7RONKWoM0O0T13VdUqWiREuw3-32u5f97gWpLitrhCptD9e3PTxdd-HiuvtMfgQAAP__1Kzsqg==

statement ok
SET optimizer_foreign_keys = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0t9q2zAUBvDr6ik-elNn1P1DdzESeuG6yubNdYqtdS2lCMWREy22FSTZxLnqQ-QJ8yQjScc2CIVdSny_73Dg-D4epLFK132EOp8bLfLZ7Q3kUubjRpUTaeCkdWj3KUIyymCkNhNp-E-tastLVSmHa1xeXAwA38dEFqIpHVpRNrKPjzsjazEuJV-p6UpMdxLX0EVxkOh6Z_TCqUqtpOGFNlJNaz6XnX3f-T7kciGNqmTtRMkPdvBc2FxMpMVMWLiZPFz0xzZW8pmyTk-NqP5LVU3pVK5Lbp1w70kSpjRgFCy4iSk6eOSoQZSwT0hGDMn3OD4lR-3bz_4VjpKMpUGUMBwvjKqE6Y5xn0Z3QfqEb_QJXoMgC3v_Ros5b7mRBV9iOEpp9DnZZ9seUjqkKU1CmmHpia2Lklv6iI63XE2W8NrffcPgLoqf_hrrNadoe6Q3ICSIGU3f9tgez9miGZcqP-sQJV9pyJCxgEUZi8IMJ88vJwNC6ON9HEQJvNE9OwVNHnrIaLzNfsAwHd2hw48vNKVocI2rAfF93yc2FzU6gs16vVm_btavyHVtnRGqdn2cX_bxfH4FH-dXL-RXAAAA__-use0M

statement ok
SET experimental_optimizer_foreign_key_cascades = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0t9q2zwYBvDj6ioeelLno-4f-h2MhB64rrJ5c51ia11DKUJx5ESLbQVJNnGOehG5wlzJSNJBB2XdocTze6QXXt_HgzRW6bqPUOcLo0U-v72BXMl80qhyKg2ctA7tIUVIRhmM1GYqDf-pVW15qSrlcI3Li4sB4PuYykI0pUMrykb28f_eyFpMSsnXarYWs73ENXRRvEt0vTd66VSl1tLwQhupZjVfyM5-7ORqKY2qZO1Eyd8t4bmwuZjKD8p8_80fGiv5XFmnZ0ZUFnNh4ebyX1TVlE7luuTWCfc3ScKUBoyCBTcxRQePHDWIEvYJyYgh-R7Hp-Sofb05nMJRkrE0iBKG46VRlTDdMe7T6C5Ix_hGx_AaBFnY-zNaLHjLjSz4CsNRSqPPySHb9pDSIU1pEtIMK0_sXJTc0kd0vOVquoLX_u4bBndRPH7zrNecou2R3oCQIGY0fZ1jt0Bny2ZSqvysQ5R8pSFDxgIWZSwKM5w8PZ8MCKGP93EQJfBG9-wUNHnoIaPxLvsfhunoDh1-fKEpRYNrXA2I7_s-sbmo0RFsN5vt5mW7eUGua-uMULXr4_yyj6fzK_g4v3omvwIAAP__3_rtbg==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0t1q2z4YBvDj6ioeelLnT90P-j8YCT1wXWXz5jrF1rqWUoTiyIkW2wqSbOIc9SJyhbmSkaRjHwS6Q4nn97y88Po-HqSxStd9hDqfGy3y2e0N5FLm40aVE2ngpHVo9ylCMspgpDYTafh3rWrLS1Uph2tcXlwMAN_HRBaiKR1aUTayj_93RtZiXEq-UtOVmO4krqGL4iDR9c7ohVOVWknDC22kmtZ8Ljv7vpPLhTSqkrUTJT9YwnNhczGR_1D2yzdW8pmyTk-NqN6Rvv8XrJrSqVyX3DrhLGbCws3kAUnClAaMggU3MUUHjxw1iBL2AcmIIfkax6fkqH372b_CUZKxNIgShuOFUZUw3THu0-guSJ_whT7BaxBkYe_PaDHnLTey4EsMRymNPib7bNtDSoc0pUlIMyw9sXVRcksf0fGWq8kSXvuzbxjcRfHTb2O95hRtj_QGhAQxo-nbHtsjOls041LlZx2i5DMNGTIWsChjUZjh5PnlZEAIfbyPgyiBN7pnp6DJQw8ZjbfZ_zBMR3fo8O0TTSkaXONqQHzf94nNRY2OYLNeb9avm_Urcl1bZ4SqXR_nl308n1_Bx_nVC_kRAAD__0qk7dA=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0tFu2j4UBvDr-ik-9abhr6a04n8xgbhIU7NlCwElXldUVZYJDvVIYuQ4EeGqD8ET8iQT0GmbVKnbpa3v9x0d6bgu7qWplC778HW6Mlqkz3e3kBuZzmuVL6SBlZVFc0oRklAGI7VZSMO_a1VWPFeFshji5vp6ALguFjITdW7RiLyWffx_NLIU81zyrVpuxfIoMYTOsjeJLo9Gr60q1FYanmkj1bLkK9lW7zu5WUujCllakfM3S3gqqlQs5F-U_fJ1JfmzqqxeGlH8syzq3KpU57yywr6jiR9Tj1Ew7zakaOGQsxpBxD4gmjBEX8Pwkpw1rz-nlz-JEhZ7QcRwvjaqEKY9xzQOxl48wxc6g1PDS_zOn9FsxRtuZMY3GE1iGnyMTtmmg5iOaEwjnybYOOLgguiOPqDlDVeLDZzmZ9_IGwfh7LexTn2JpkM6A0K8kNH4dY_DIV2t63mu0qsWQfSZ-gwJ81iQsMBPcPH4dDEghD5MQy-I4Eym7BI0uu8goeEh-x9G8WSMFt8-0ZiixhC9AXFd1yVVKkq0BPvdbr972e9ekOqyskao0vbRvenjsduDi27vifwIAAD___eh7jI=

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_foreign_keys

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJx8jkFP3DAQRu_-Fd-xrWppswsNZcUhTV1ppU2gSVhxs4wzSVycGGwH0f31VcoN0N5GmvdmHuc4kA_GTZfInX7wTunh5w_QC-n72diWPCKFiOdXirFaNPDkfEte_nFmCtKa0URcIVmttgDnaKlTs414VnamS5wxzkGTurckj6Y_qv6_iEEFxIHe4m5aePcYzWiO5GXnPJl-kg_0N5xwli56eSRvRpqisvLDC1KroFVLAVdwXfdh79uAOZAcTIiu92o8lfDOGmcbjXZWhqjiKZPllcgagVr8vhVlLhDoCcWuPGT7W4EERXb3On5frzebdL3afLs4P0vT84tVil2ZV6IQZYMEdZNVDZItY-LuZp_tSny6vmm-QpSHz6jFXuQNvuBXdV0sL7aMc85ZoKeZJk08kCUdlw37FwAA__8KnrJV

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4kIvlTepkew9FDICTHXpTZsjB5KWNggCgpJpm4ssGiSlyRkGFPsGP-7r_CWDZCdR3cxYH-IHArz3nMNzzUPZNlwzqbgoPBiJ7F4Kmi0_vAdWsywteT5jEjRTGqo9CqEYJyCZkDMmye-CF4rkfMU1XIDrOEMA24YZm9My11DRvGQe_IBsG1hB05yRB754oIuWCEuqQC_ZMVwUDV6sNV_xBybJXEjGFwW5Zxt1gtP4YvWaSb5ihaY5eVGBZFRldMYUXICYz1_0e2ygVIwsudJiIenqlIWvWKsy1zwTOVGa6lNMNIqwn2BI_PcTDDWY6IxCECbvIJwmEP42mVjoLD1U9rvRNIyTyA_CBIy15CsqNwZcRcGlH93Ar_gGTAp-POpZ6CwIP-BPUJOU8FkNZvpYH_uXweSmQzepBWkP9YYI-ZMERwc_TQDerss059nbGoLwFzxKIE78JIiTYBTDm1sEAPBnuzY_IxN5uSqU4cHtU7FtUONpf2d18JJRzWaEasMDo--472zHtR0XHNdzHM9xvm9Xo0OZcaV5kWmSibJoaK7jdNrthZHmv9ebNWtUu-SizPMnYpcmxR_Pgv2B2x-0vb-s_z1h-ooTtoZeb0h092Z4FMVNE8XyqyhW3xjF8jFyHej8nlREsjmpYTyNcPBTuMdWPYjwGEc4HOEYapM-R3hDqn2Eq_-OcGlBdTrCmxcj3J39OsAfodo_BwtaRfBjiPGkoT1XYRxNL798HtbRUR9_xhGGFC5gMEQIf7qa-EEI5vQqsQCH171H0e_2WtUQ2bZtI14UTNrtZ9LMpFCqh2C3_We3_bzbfgaV0eLLc0526x8Pb79B_d1c9W67PYAzUSgtKS-0B-f9c9eD2_MB2HA-uEMd2JznmkkFppYl66F_AwAA___2vM9l
