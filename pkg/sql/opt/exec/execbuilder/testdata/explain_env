# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lNFu2jwUx6_rpzjKTeET-Ujgpgqq9KU01ZeNhgqyrlVVWU5iwMPYmePQwDSpD8ET9kkmh7ZjkxjrRXMRyT7_3_E55x_HtuGaqoJJ4UFfpnMlSTo7PwNa0TQpGc-oAk0LDcutCiHbBkWlyqjCXyQTBeZswTTMSAF6RiGjE1JyDUvCS-rBidFTQRJO8ZpN12RaU_vkUhi9zDVbsDVVuCwonrFCy6kii-It1KLkmqWS40ITfYDkMiWc6RV-SZHhnCjNNJOCZpiJjFa4SMmBsnMlczIlmmIm8lLjekhMTPdSk8kWoxOqMJdyXubPM51IhSfz_WVvSSY0VUvCC73iFG-nnB1gMmLsfIOeFYRz-YAnJedY10aaURyqjRM1pVvIyLGSD3sR13EcNA5ic5guvnI4NVl6AOb8X6Wk1NKkX9JUS8XW9A-WoP4o8OMAYv9sEEBeJpyl_1bQQEcEwig-gWgYQ_RpMGiho-R5Z7vqD6NxPPLDKIYK53O6gqtReOmPbuFjcAsNAv6432yhozA6D26gwglmWQWN5GX_wr8MB7dg5YotiFpZ0CAtSJqo2UPIH8TB6PeawuhD0I9hHPtxOI7D_hiO7xAAwLf6bR4rlbxciMLy4O51sw4Q63V939rRK0o0zTDRlgdWx3FPbMe1HRcc13Mcz3GsHbGZPBOpxqkshQFcx9kJ13cQm-ukVzk1-XZhYVx-AXcxJR9-Jux03U63jn1v_XVvybv0Vpfyfu2h--MeQsHN1cAPI2gMr-IWBNF1E8bBwNj8D1yMhpdQwef_g1EACZxCt4ds27ZR_Zep_nv-pBA8bTZPm8enzSOkUhRaESa0B-1O2_Xgrt0FG9rde_QjAAD__5Civ6w=

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lcFu4zYQhs_hUwx8WbuwGjm-BA4WqNbLtGodOZDV7QZBQFAS5bCmSZWkFClFgUWfwcc-XZ6koJxk3W5cdw_xwYBmvn80nPlpex58YNpwJScwVdlKK5rdvn8HrGFZWnGRMw2WGQv1lkLI80AzpXOmya-KS0MEX3MLt9SAvWWQs4JWwkJNRcUmcOp4JmkqGLnny3u67FT7cCUdr0rL1_yeaVIZRm65sWqp6dp8jWpdCcszJYix1B5QCpVRwW1LnkrkpKTacsuVZDnhMmcNMRk90HapVUmX1DLCZVlZ0g2Jy-VeVVFsZaxgmgilVlX5ONNCaVKs9re9VXJpma6pMLYVjGynnB_Q5NSt8yt4bqgQ6o4UlRDEdot0ozjUm6B6ybYihxOt7vZKRr7vowVO3Mus-U3AW1flDMC9_58oraxy5WuWWaX5PfuPlaBpjIMEQxK8m2Eoq1Tw7NsG-uiIQhglpxDNE4h-ns2G6Ch9jGyfpvNokcRBGCXQkHLFWriMw4sgvoKf8BX0KQSL6WCIjsLoPf4IDUkJzxvop0_x8-AinF1Br9R8TXXbgz4dQjpAgzOEglmC43_3FEY_4mkCiyRIwkUSThfw5hoBAPzefbtPL1OiWkvTm8D1c7BL0N7z881wh9eMWpYTansT6J34o1PPH3n-CPzRxPcnvt_bgd3kucwsyVQlnWDk-zvp7g4Sd51sWzJXb1cs3ZafhLsyre4-FzwZj07GXe6P4f8-W_oqZ-taeb3joZs3Zy-7r3Xuq75wX73Pfe0L7queXLbDFStSE80K0sD5PMbh99GWrQcQ43Mc42iKF89269PP5m1JvTVvvd-81RDqveZtXzRvNwH88XIWhBH055fJEHD0YQALPHPsN3Aezy-gGUILv_yAYwwpvIXxGfI8z0NcSqa97n-in2llzADBw-avh82nh80n6H6I2y8izXeP99Bl_nR7eNhsHoFMSWM15dJO4PjkeDSB6-MxeHA8vkE7WMGFZdpA3-qKDdDfAQAA__9W-SrE

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0lN-O4jYUxq_HT3GUm4WKVGH2ZgTaiyybldIyYUTS1Y5GI8tJTsDF2KntQKCqtA_BZZ9unqRymNnSSpTOxXCBYn_f7_j8ke378AW14UqOYKKKlVasWH76CNhikTdclKjBorGwOboI8X3QqHSJmv6quDRU8DW3sGQG7BKhxIo1wsKGiQZHcOP8KFkukO75Ys8WHXXOrqTzq9ryNd-jpo1BuuTGqoVma_Maat0IywslqLHMXiCFKpjgdkdfQpS0Ztpyy5XEknJZYktNwS6kXWtVswWzSLmsG0u7JnG5OEtV1RHDCjUVSq2a-rmnldK0Wp1P-0hyaVFvmDB2J5Aeu1xeYErmxvkKPzdMCLWlVSMEtd0gXSsu5SaYXuARcnaq1fYsMgyCgKRR5g6z5jcBH1yUMYA7_59W1ljlwm-wsErzPf7HSMhkHoVZBFn4cRpB3eSCFz-20CNXDOIku4FklkHyy3Q6IFf5885xNZklaTYP4ySDltYr3MHdPL4N5_fwc3QPPQZhOukPyFWcfIq-QktzyssWevnL_ufwNp7eg1drvmZ650GPDSDvk_6YkHCaRfN_5xQnP0WTDNIszOI0iycpvHsgAAC_d__u5xVKNGtpvBE8fN_sBOZ9Xz8OTvwamcWSMuuNwLsOhjd-MPSDIQTDURCMgsA7MbvOc1lYWqhGOmAYBCdydwepu052V6OLdwpLN-UX8BTTavt3wOv3w-v3nfbH4H_Xlr9JbV0qb1ceeXw3JiT6ejcN4wR6s7tsAFHypQ9pNHVj_gE-z2e30EKYgpI4OH7ZrRoT3_d9wqVE7XfvZK_Qypg-gafDn0-Hb0-Hb9A9RC08MPNBSXw8I9mt6qTDs1RxYVEb6FndYJ_8FQAA___0m9gg

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20wUhtfMVRyxIfmEP0CRKpSIhQmT1q1xkO1SEEKjwT5Oppl43PkxcVZcRK6QK6kcw6KoNGJp63mO3nnP8Ty4Rm2EKocwVtlCK57NL84BV5g9OCFz1GDRWKg7ipCEpqBR6Rw1-6lEaZgUS2HhDD4NRgCeBzkW3EkLNZcOh3BKPA-w5A8S2VrM1ny29WDODdg5vsVV2fKqsmIp1qiZM8jmwlg103xpPmItnbQiU5IZy-0OU6qMS2Eb9joiZxXXVlihSsyZKHNcMZPxHbErrSo-4xaZKCtn2bYmUc7etYqi07BAzaRSC1e9tFoozYrF-7E7U5QWdc2lsY1E1rWc73By3m70A7wwXEr1yAonJbPbRbZV7MomuZ5hJ7U40-rxXeXk-Ph4e1q5MNb8knDWTvnrPXFnVTu-xswqLdb4j5WQcUz9lELqn4cUKvcgRfZ_Az2y5yCI0lOIpilE38PwkOzVL3-6r_E0StLYD6IUGlYtsIGrOLj041v4Rm-h58BPxv0_uWLBaqaxYCuYTGMafI46tu5DTCc0ptGYJq8hVj3e6kF0QW-gYTUT-Qp69evYiX8ZhLewX2mx5LrZh547hLpP-iNC_DCl8dsnBdFXOk4hSf00SNJgnMDB3f3BiBB6cxX6QQS96VV6CDS67kNCw5b9Dybx9BIa-PGFxhQcnMFgRDzP88j20hsCz5vN8-bpefMEmSqN1VyUdghHJ0O4OxqAB0eDe_I7AAD__8vram8=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20wUhtfMVRyxIfmEP0CRKpSIhQmT1q1xkO1SEEKjwT5Oppl43PkxcVZcRK6QK6kcw6KoNGJp63mO3nnP8Ty4Rm2EKocwVtlCK57NL84BV5g9OCFz1GDRWKg7ipCEpqBR6Rw1-6lEaZgUS2HhDD4NRgCeBzkW3EkLNZcOh3BKPA-w5A8S2VrM1ny29WDODdg5vsVV2fKqsmIp1qiZM8jmwlg103xpPmItnbQiU5IZy-0OU6qMS2Eb9joiZxXXVlihSsyZKHNcMZPxHbErrSo-4xaZKCtn2bYmUc7etYqi07BAzaRSC1e9tFoozYrF-7E7U5QWdc2lsY1E1rWc73By3m70A7wwXEr1yAonJbPbRbZV7MomuZ5hJ7U40-rxXeXk-Ph4e1q5MNb8knDWTvnrPXFnVTu-xswqLdb4j5WQcUz9lELqn4cUKvcgRfZ_Az2y5yCI0lOIpilE38PwkOzVL3-6r_E0StLYD6IUGlYtsIGrOLj041v4Rm-h58BPxv0_uWLBaqaxYCuYTGMafI46tu5DTCc0ptGYJq8hVj3e6kF0QW-gYTUT-Qp69evYiX8ZhLewX2mx5LrZh547hLpP-iNC_DCl8dsnBdFXOk4hSf00SNJgnMDB3f3BiBB6cxX6QQS96VV6CDS67kNCw5b9Dybx9BIa-PGFxhQcnMFgRDzP88j20hsCz5vN8-bpefMEmSqN1VyUdghHJ0O4OxqAB0eDe_I7AAD__8vram8=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks1O20wUhtfMVRyxIfmEP0CRKpSIhTGT1q1xkO1SEEKjwT5Oppl43PkxcVZcRK6QK6kSw6JVIe3S1vO8OvOe43lwjdoIVQ0hUPlcK57PLs4Bl5g_OCEL1GDRWGg6ipCUZqBR6QI1-65EZZgUC2HhDD4MRgCeBwWW3EkLDZcOh3C6VbDiDxLZSkxXfLoV4QxUWf5RURXxPFC1FQuxQs2cQTYTxqqp5gsDM27AzvBvrIWTVuRKMmO53WFKlXMpbMteIwpWc22FFarCgomqwCUzOa_ej6m1qvmUW2Siqp1l26pENX3TKstOwxI1k0rNXf3SbKk0K-dvj92ZorKoGy6NbSWyruhih1PwzVb_gReGS6keWemkZHa7y00Vu2aTXE-xkzY40-rxTeXk-Ph4eyuFMNb8kO8cCHdWbeIbzK3SYoXvrIQECfUzCpl_HlGo3YMU-f8t9MiegzDOTiGeZBB_jaJDste8_Om-gkmcZokfxhm0rJ5jC1dJeOknt_CF3kLPgZ8G_V-5cs4aprFkSxhPEhp-jDu26UNCxzShcUDT1yGWPb7Rw_iC3kDLGiaKJfSa19ixfxlGt7Bfa7Hgut2HnjuEpk_6I0L8KKPJ708K4880yCDN_CxMszBI4eDu_mBECL25ivwwht7kKjsEGl_3IaXRhv0PxsnkElr49okmFBycwWBEPM_zyPbSWwLP6_Xz-ul5_QS5qozVXFR2CEcnQ7g7GoAHR4N78jMAAP__80Bq0Q==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUkt1O2zAcxa_xU_zFDe1EBqjShFpxEYK7ZQspSjwGQsgyidN6dePMH6HpFQ_RJ-RJpiZwMUSLdmnr_I6Oz7HnwTXXRqhyCIHK5lqxbHZxDnzJswcnZM41WG4s1J0KoRQT0FzpnGv6W4nSUCkWwsIZfBmMADwPcl4wJy3UTDo-hNMW4SV7kJyuxHTFpi0IZ6CK4l1ElS2jKisWYsU1dYbTmTBWTTVbmN2k570BF05akSlJjWXWwIwZsDP-PilVxqSwDX21yGnFtBVWqJLnVJQ5X1KTsXK3TaVVxabMcirKylna1iXK6VaqKDqMF1xTqdTcVS_tFkrTYr49dkeK0nJdM2lsIzntys4_YHK2WfY_9MIwKdUjLZyU1LZ7bqr4KJtkeso7aCOnWj1uRU6Oj4_b7XNhrPkjd0zNnFUb-5pnVmmx4jsmQUGCfYKB-OcRhso9SJF9bqCH9hyEMTmFeEIg_hlFh2ivfrnpTsEkTknihzGBhlZz3sBVEl76yS38wLfQc-CnQf9fXTGnNdW8oEsYTxIcfo07bd2HBI9xguMAp68hlj22wcP4At9AQ2sq8iX06lfbsX8ZRrewX2mxYLrZh547hLqP-iOE_Ijg5O2Twvg7DgikxCdhSsIghYO7-4MRQvjmKvLDGHqTK3IIOL7uQ4qjjfYTjJPJJTTw6xtOMDg4g8EIeZ7nofanNwie1-vn9dPz-gkyVRqrmSjtEI5OhnB3NAAPjgb36G8AAAD__1fCazM=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyUks9O20oUxtfMUxyxIbnCF1CkK5SIhTGTW7fGQbZLQQiNBvs4mWbiceePibPiIfKEPEkVBxatgIilrd_v0_H32fPgGrURqhpCoPK5VjyfXZwDLjF_cEIWqMGisdBsKUJSmoFGpQvU7KcSlWFSLISFM_hvMALwPCiw5E5aaLh0OITTTsGKP0hkKzFd8WknwhmosnxTUVXnqNqKhVihZs4gmwlj1VTzhfmsuXDSilxJZiy3O2zPA6lyLoVt2WtKwWqurbBCVVgwURW4ZCbnFcy4ATvDt2NqrWo-5RaZqGpnWVeZqKbvWmW51bBEzaRSc1e_NFwqzcq52WGKyqJuuDS2lci2hRc7nIJv1v0ELwyXUj2y0knJbLfppopdt0mup7iVNjjT6vFd5eT4-LhbsRDGml_yg8G4s2oT32BulRYr_GASEiTUzyhk_nlEoXYPUuT_ttAjew7CODuFeJJB_D2KDsle8_Jm-xRM4jRL_DDOoGX1HFu4SsJLP7mFb_QWeg78NOj_yZVz1jCNJVvCeJLQ8P94yzZ9SOiYJjQOaPp6xLLHN3oYX9AbaFnDRLGEXvMaO_Yvw-gW9mstFly3-9Bzh9D0SX9EiB9lNPn7k8L4Kw0ySDM_C9MsDFI4uLs_GBFCb64iP4yhN7nKDoHG131IabRh_4FxMrmEFn58oQkFB2cwGBHP8zzS_ektgef1-nn99Lx-glxVxmouKjuEo5Mh3B0NwIOjwT35HQAA___-l2uV

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUklFv2jAUhd_zK-7jNs0TlLWwoj6wzJOQIO0gRX2zTHIT7jB2sK9py6-fQraXaQz1zZLPd3R0zhUCVugDOXsLqSu23uli8-0r4AsW60imRA-MgeHQqZJkKXPw6HyJXv10ZIMytCOGO7gZjAGEgBIrHQ3DQZuItzBKhAC0em1QHak-6vrEwUYH4A3-LXe21buGaUdH9CoGVBsK7Gqvd-Et1C4apsIZFVjzBdK4QhviV_XHolSN9kxMzmKpyJb4okKhL8RuvGt0rRkV2SayOtVEtj5LVVWHYYVeGee2sfndauW8qrbnY3ckWUZ_0Cbwq0HVtVxeYErdLvoGPQVtjHtWVTRG8WnItopL2Yz2NXZQK1fePZ9F-r1e73RaJQUOewN3rcs_70lHdq39AQt2no74n0mSdCEnuYSl_PEos1RCE9eGik8B9zCfZqvJ7FFCH-aTp-755epqMBhe9QY3o-vPw-H1qDeEaZYu5FxmOfRhmU8WOfTHSSKfHmaTaQbv7h_yjyCz1XtYyplMc_gA3xf3cwi4HydCCJEE3Ee0BYqABgtuf5JfAQAA__83zjAS

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VcFu4zYQPYdfMfBl7ULayDFQBDYCVOtlWrWOHEhqdoMgICiJcljTokpSipWiwKLf4GO_Ll9SSIoTdzeuu4f1wQBn3nsYzrwRbRuumNJc5mOYymSpJE3u3r8DtmZJXHKRMgWGaQNVh0IoxBEoJlXKFPlN8lwTwVfcwBl8P5oA2DakLKOlMFBRUbIxnCLbBpbTWDDywBcPdNHy4I5qMHfsc7jMG7wsDF_xB6ZIqRm549rIhaIr_TWsVSkMT6Qg2lBzgClkQgU3NdlKpKSgynDDZc5SwvOUrYlO6IGyCyULuqCGEZ4XpSFtm3i-2MvKso7GMqaIkHJZFk9dzaQi2XJ_2R2T54apigptasFI1-X0ACelzUS_As81FULek6wUgph2kE0rDtUmqFqwjtTAiZL3eylDx3Faa6VcG_27gLNG5VU_0dLIRr5iiZGKP7D_GAmaBtiNMETuuxmGoowFT96uoY-OKHh-dAr-PAL_19nMQkfxU6Q7Ted-GAWu50ewJsWS1XAZeBducA2_4GvoU3DD6cBCR57_Hn-ENYkJT9fQj7fxc_fCm11Dr1B8RVXdgz61IB6gwQQhdxbh4POaPP9nPI0gjNzICyNvGsKbGwQA8Ef73_x6iRTlKte9Mdw8B9sE7T2fb60dvGLUsJRQ0xtD78QZntrO0HaG4AzHjjN2nN4OuOk8zxNDElnmDWHoODvpdgdJs06mLlijt0vOmylvibs0Je9fBE9Gw5NRm_vT-t93i7_J3dpSvt310O2byevuqxv3lV-4r9rnvvoV95Vbl-3gsiWpiGIZWcP5PMDej36HrQYQ4HMcYH-Kw2e79emLeWtSdeat9pu3tKDaa976VfPuduDKwx-26KpbBQtaTXBDCPGsYb9E4TyYX7Tvztttwda_jjV8-AkHGGI4g9EEIfzxcuZ6PvTnl5EF2L8abEW_67SqCbJt20Y8z5my2_ennyip9QDB4-bvx82nx80naD_w9ReR9Q9P-91k_mrm-7jZPAESmWujKM_NGI5PjodjuDkegQ3Ho1u0A8u4MExp6BtVsgH6JwAA__-uCERe

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyUkkFr20wQhs_ZXzHkEvsj-nAplBCTg6IqoFaWjbQNNaUsE2kkb73WqrsjJ_avL7JbKKWuyf15ZoZ33iCAR3Je2_YWIluuncVy9f4e6IXKp16bihwweYbtkRKiiCU4sq4ip75Z3Xpl9EYz3MG7t1OAIICKauwNwxZNT7dwI4IAqMUnQ2qvmz02Bw9W6IFX9Cdu24G3HeuN3pNTvSe10p5t43DjX2NtesO6tEZ5Rj5jGlui0bxTv0ZUqkPHmrVtqVK6rehF-RLPnN0522GDTEq3Xc_qEJNum5NWXR81qskpY-26736mWlun6vXps4-mbpncFo3nnSF1TLk641Q4fPQVvPZojH1WdW-M4sMjhyjO3WbQNXSUBlw5-3xSeTOZTA7VqrRn_93A3TDlr33Cnu0wfkslW6f39I-XiCiPQxmDDO_TGPz_DCNxgZBk8gayuYTsU5pei4tonhUyD5NMAqtuTTtY5MkszJfwMV7CCCEsovG1uHgIZ0m6hMvO6Q263SWMcCzGUyHCVMb5b1uS7EMcSShkKJNCJlEBV1--Xk2FiD8v0jDJYDRfyGuIs8cxFHE6sP_BQz6fDfZUBEEQiEPbWPwIAAD__3aYOPU=
