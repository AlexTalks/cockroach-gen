# LogicTest: local

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_buckets": []
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_buckets": []
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20wUhdfMUxx5Q_IrJnayQUa_VBOM6tY4yHEpCKHR2B7ItOOZaDymhqoSD5En5EkqB0qzQW0XeGHp3nu-q3t0xnVxxk0jtAow0-VXo1m5PDoE73hZtEJW3MDyxuL2SUWI68JwbSpu6BctVEOlqIXFkjWwS46KX7NWWtwy2fIA-72eK1ZITu_FzT272VCvybXq9XplRS3uuaFtw-lSNFbfGFY3_0LVrbSi1JI2ltk_kLxbcSNqriyTdMWMFUxSoSre8dfJ62tCZlkU5hHy8DCJ0GFAdhjiNN9HOs-RfkqSEdkpnjtP1WyeLvIsjNMczsqImpk7B6dZfBJmF_gYXWDAEC5mwxHZidOj6BwdLaioOgyKX_3j8CROLrbwARuhGJLhASFhkkfZ8z19bHurtpCi3OsQpx-iWY5FHubxIo9nC-xeEgD4vvn3n1Nq2daqcQJcvjQ3A-a81FejLb3hzPKKMusEcCaev-96vuv58PzA8wLPc7bElWisUKWlpW5VD_ietzXepEz7wOzdivf7tmHVSvkCbmNGf_u9cDL1J9PN7Mfor70Vb-Jtc8rb2SNXuweEROenSRinGMxP8xGi9GyIRZT0Mf-H42x-gg6f30dZhAL_Y3pAXNd1SVMyhe7d87sieFyvH9cPj-sHlFo11jChbIDxZOwHuBxP4WI8vSI_AwAA__9VkitN

statement error ENV only supported with \(OPT\) option
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0ksFO20wUhdfMUxx5Q_IrJnayQUa_VBOM6tY4yHEpCKHR2B7ItOOZaDymhqoSD5En5EkqB0qzQW0XeGHp3nu-q3t0xnVxxk0jtAow0-VXo1m5PDoE73hZtEJW3MDyxuL2SUWI68JwbSpu6BctVEOlqIXFkjWwS46KX7NWWtwy2fIA-72eK1ZITu_FzT272VCvybXq9XplRS3uuaFtw-lSNFbfGFY3_0LVrbSi1JI2ltk_kLxbcSNqriyTdMWMFUxSoSre8dfJ62tCZlkU5hHy8DCJ0GFAdhjiNN9HOs-RfkqSEdkpnjtP1WyeLvIsjNMczsqImpk7B6dZfBJmF_gYXWDAEC5mwxHZidOj6BwdLaioOgyKX_3j8CROLrbwARuhGJLhASFhkkfZ8z19bHurtpCi3OsQpx-iWY5FHubxIo9nC-xeEgD4vvn3n1Nq2daqcQJcvjQ3A-a81FejLb3hzPKKMusEcCaev-96vuv58PzA8wLPc7bElWisUKWlpW5VD_ietzXepEz7wOzdivf7tmHVSvkCbmNGf_u9cDL1J9PN7Mfor70Vb-Jtc8rb2SNXuweEROenSRinGMxP8xGi9GyIRZT0Mf-H42x-gg6f30dZhAL_Y3pAXNd1SVMyhe7d87sieFyvH9cPj-sHlFo11jChbIDxZOwHuBxP4WI8vSI_AwAA__9VkitN

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lFFP2zoUx5_xpzjKC-lVQtP2BQVd6Ybi3pu7kqI0YyCELCd1qUfqVLaTJUyT0D5DH_fp-kmmpAWiMbbxQB8q-Zzf3_LR-bW2DedMKp4JF4ZZciszmixOjoGVLIlzns6YBM2UhmJLIWTbIFkmZ0ySjxkXiqR8yTUsqAK9YDBjc5qnGgqa5syFw5pngsYpI3f85o7eNKmX8EzUfLbSfMnvmCS5YmTBlc5uJF2q16SWeap5kqVEaap_k2Tlikm-ZELTlKyo1JymhIsZK9nLyfkcoWGIvQhD5B2PMZRgoj0KfhAdQjCJIHg_HltoL95VtqfhJJhGoecHERgryZdUVgachf6pF17CO3wJJgVvOuxYaM8PTvAFlCQmfFaCGT_UR96pP75sxU1qQdxBnSOEvHGEw9176rUdrPI45clBCX7wPx5GMI28yJ9G_nAK-1cIAOBz811_jCRL86VQhgtXj8WmQY3H87XV4iWjms0I1YYLRt_pHdpOz3Z64PRcx3Edx2jBM640F4kmSZaLOtBznFa72TKpF6arFavva4dFnqaPwXZMZp-eLuwPev1B0_ti_fFs8ZvM1jzl7cZD1_tHP-hX1frlz_QrXqlf_qBZC53fkoJINicljCYh9v8NtmzRgRCPcIiDIZ5CadInbStSbLUtXtY2t6D4tbbVT7VtZscXZ2PPD8CcnEUW4OC8A1M8rtm_YBROTqG0oIIP_-EQQwx_w-AI2bZtIy4Ek3bzH2QmMlOqg2Cz_rZZ32_W96ASKqB6Vin_2f0M687XegOb9XoHJJlQWlIutAvdfrfnwlV3ADZ0B9eohc15qplUYGqZsw76HgAA___a05Oh

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0k8FO20AQhs_sU4x8wals5MAFhZMJRnJrHBRvEQih1dqekG3Xu9HuGgxVJR4ixz4dT1LZ0DRShdoe8MHy_PN_oxn9chjCBRortJrAVFdfjebV8uQYsMOqbIWs0YBD6-DuxUVIGIJBbWo07IsWyjIpGuFgyS24JUKNC95KB3dctjiBw96PipcS2aO4feS3A_WWXaver1dONOIRDWstsqWwTt8a3tj_oZpWOlFpyazj7i8kdis0okHluGQrbpzgkglVY4dvk4sFIdN5EtMEaHycJdCBT3Y4pDk9hHxGIf-cZQHZKV-Vl2o6yws6j9OcgrcyouHmwYPzeXoWz6_gU3IFPoe4mI4CspPmJ8kldKxkou7AL3_pp_FZml1t4T4PoByR0REhcUaT-es-fWx7q7aUotrrIM0_JlMKBY1pWtB0WsDuNQEA-Da8-8ertGwbZb0JXG_EocG9TX0TbPkNcoc1486bgLcfjQ_DaBxGY4jGkyiaRJG3Za6FdUJVjlW6VT0wjqKt9pAy6wNzDyvs523DqpVyA25jRt__Hrh_MN4_GHrfg3--rXyX24ZV3u88crN7REhyeZ7FaQ7-7JwGkOQXIyiSrI_5A5zOZ2fQQVyAVhi8fLl7fUTCMAyJUApNOPyJfmW0tSMCz-sfz-un5_UT2IqrHvtDc_e619av2kJIh8aC70yLI_IzAAD__10tPv8=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zwYx_Hj6ip-9KTOS9TwEhgloQeuq2zeHCXYWtdQilAcJdHqP0GWjZ2jXkSuMFcysnSwDcbYocTnK_HwUIoHbStTFiMEZfpiS5Vu7--gW50ua5OttIXTlUNzVoQkTMDq0q60lV9LU1QyM7lxuMW74RigFCu9VnXm0Kis1iPcEEqhC7XMtNybzV5tvnfYqgpuq3_nZXHy5c6Z3Oy1lXWl5dZUrtxYlVf_UuV15kxaZrJyyv2l1O1OW5PrwqlM7pR1RmXSFCvd6j-X6zUhQcx8wSD8u4ihg0cuaoRc3IDPBPjnKOqTi-bt5nwKZjwRsR9ygcudNbmy3SXmcTj14wU-sQW8Gn4S9H6l6xfZSKvXssVkFrPwPT_bpoeYTVjMeMAStJ46dSG_Z4_oZCPNqoXX_Hhv4k_DaPHTt17dR9MjvTEhfiRY_DbHaePXu3qZmfS6Q8g_skAgEb4IExEGCa6enq_GhLDHeeSHHN5sLvpg_KGHhEUn-x8m8WyKDl8-sJihxi2GY0IppaRKVYGO4Hg4HA-vx8Mr0rKonFWmcCMM_h_haTAExWD4TL4FAAD__93P01M=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zwYx_Hj6ip-9KTOS9TwEhgloQeuq2zeHCXYWtdQilAcJdHqP0GWjZ2jXkSuMFcysnSwDcbYocTnK_HwUIoHbStTFiMEZfpiS5Vu7--gW50ua5OttIXTlUNzVoQkTMDq0q60lV9LU1QyM7lxuMW74RigFCu9VnXm0Kis1iPcEEqhC7XMtNybzV5tvnfYqgpuq3_nZXHy5c6Z3Oy1lXWl5dZUrtxYlVf_UuV15kxaZrJyyv2l1O1OW5PrwqlM7pR1RmXSFCvd6j-X6zUhQcx8wSD8u4ihg0cuaoRc3IDPBPjnKOqTi-bt5nwKZjwRsR9ygcudNbmy3SXmcTj14wU-sQW8Gn4S9H6l6xfZSKvXssVkFrPwPT_bpoeYTVjMeMAStJ46dSG_Z4_oZCPNqoXX_Hhv4k_DaPHTt17dR9MjvTEhfiRY_DbHaePXu3qZmfS6Q8g_skAgEb4IExEGCa6enq_GhLDHeeSHHN5sLvpg_KGHhEUn-x8m8WyKDl8-sJihxi2GY0IppaRKVYGO4Hg4HA-vx8Mr0rKonFWmcCMM_h_haTAExWD4TL4FAAD__93P01M=

statement ok
SET enable_zigzag_join = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyM0cFq2zAcx_Fz9RQ_eqkz4oYRGCUhB9dVNm-OE2ytayhFKI6caLWtIMvGzqkPkSfMk4w0HWywsR0lvh-JP3_Xxb00ldLlCL5On40W6fbuFrKV6apW-VoaWFlZNOeKkIQyGKnNWhr-Xauy4rkqlMUEH4ZjwHWxlpmoc4tG5LUc4eaVyFKscsn3arMXm1eICXSW_ZHokrgu9M6qQu2l4XUl-VZVVm-MKCpsRQW7lf-jijq3KtU5r6yw_5Cy3UmjCllakfOdMFaJnKtyLVv5d5llhPgx9RgF825Dig4OuagRROwG0Zwh-hqGfXLRvN2cT_48SljsBRHD5c6oQpjuEos4mHnxEl_oEk4NL_F7v6fZM2-4kRlvMZ3HNPgYndumh5hOaUwjnyZoHXFyQXRHH9Dxhqt1C6f5-d7UmwXh8pdvnbqPpkd6Y0K8kNH4bY7T1q939SpX6XWHIPpMfYaEeSxIWOAnuHp8uhoTQh8WoRdEcOYL1geN7ntIaHhq32Eaz2fo8O0TjSlqTDAcE9d1XVKlokRHcDwcjoeX4-EFqS4ra4Qq7QiD9yM8DoZwMRg-kR8BAAD__2P607U=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJx80d9q2zwYx_Hj6ip-9KTOS93wEhglIQeuq2zeHCfYWtdQilAcOdHqP0GSjZ2jXkSuMFcyknSwjW6HEt-PxMPjuniQ2qiqHMKv0hddiXRzfwfZynRZq3wlNaw0Fs25IiShDFpWeiU1_16p0vBcFcpijA-DEeC6WMlM1LlFI_JaDnF7IrIUy1zynVrvxPoEMUaVZe-SqjyZamtVoXZS89pIvlHGVmstCvNv6bp_wKLOrUqrnBsrrMFGGNiNfF_Kdiu1KmRpRc63Qlslcq7KlWzl32WWEeLH1GMUzLsLKTo45KJGELFbRDOG6GsYXpOL5u3mfPJnUcJiL4gYLrdaFUJ3l5jHwdSLF_hCF3BqeInf-z3NXnjDtcx4i8kspsHH6Nw2PcR0QmMa-TRB64ijC6J7-oiON1ytWjjNz_cm3jQIF79869TXaHqkNyLECxmN3-Y4bv5mWy9zld50CKLP1GdImMeChAV-gqun56sRIfRxHnpBBGc2Z9eg0UMPCQ2P7X-YxLMpOnz7RGOKGmMMRsR1XZeYVJToCA77_WH_eti_Iq1KY7VQpR2i__8QT_0BXPQHz-RHAAAA__8nQ9QX

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJyU0d9q2zAUx_Hr6il-9KbOqBtGYJSEXLiusnlznGBrXUMpQnHkRKv_BEk2dq76EHnCPMlI0sHGBmOXEt-PxOG4Lh6kNqoqh_Cr9EVXIt3c30G2Ml3WKl9JDSuNRXOuCEkog5aVXknNv1eqNDxXhbIY48NgBLguVjITdW7RiLyWQ9yeiCzFMpd8p9Y7sT5BjFFl2V9JVZ5MtbWqUDupeW0k3yhjq7UWhflfWdS5VWmVc2OF_Yd2Xch2K7UqZGlFzrdCWyVyrsqVbKXBRhjYjfxDZhkhfkw9RsG8u5Cig0MuagQRu0U0Y4i-huE1uWjebs4nfxYlLPaCiOFyq1UhdHeJeRxMvXiBL3QBp4aX-L3f0-yFN1zLjLeYzGIafIzObdNDTCc0ppFPE7SOOLoguqeP6HjD1aqF0_x8b-JNg3Dxy7dOfY2mR3ojQryQ0fhtjuP2b7b1MlfpTYcg-kx9hoR5LEhY4Ce4enq-GhFCH-ehF0RwZnN2DRo99JDQ8Ni-wySeTdHh2ycaU9QYYzAiruu6xKSiREdw2O8P-9fD_hVpVRqrhSrtEP33Qzz1B3DRHzyTHwEAAP__LO7UeQ==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyUzUHr2jAYx_F7XsXvuI0F1E7rlB26LgPBVtdW8RZi-2izpY0mqYivfjhvgzH-twee74cf59iT89r2C6S2_uWsqttvX0F3qo-DNg05BPIBt1fFWCkqOLKuISd_Wt17aXSnA75gFi0BztHQSQ0m4KbMQAvMGeegXh0NyYc-P9T5j0OrPEJLf-e2f_b2EnSnH-Tk4Em22gd7dqrzb1HdYIKurZE-qPAfSfcLOd1RH5SRF-WCVkbqvqE7_VueToylhUgqgVL82Ik8FfB0RbbK98l6JzBGlhxe5-fJJIriySiazaef4ng6H8VY5WkhMpFXGKOskqLCeMmYOGzXySrHu822-giR79-jFGuRVviA78Ume04sGeecM0_XgfqauCdDdXh-2O8AAAD__7f4mP4=

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9O20oQxq_Zpxj5BufIJk4iHSFHSMeEzTk-DQ6yXf4IodXa2ZAtjh3trl2HqhLqM-SyT5cnqewEMLTQckEuIu3M983uaH5j04RTJiTPUhsGWXwjMhrPjg6BlSyOcp5MmADFpIJio0IowCEIlokJE-RTxlNJEj7nCg7g714fwDRhwqY0TxQUNMmZDfvINIGlNEoYueXXt_S69sGMSlAz9lyepZU-Wyg-57dMkFwyMuNSZdeCzuVbXPM8UTzOEiIVVb9xsnLBBJ-zVNGELKhQnCaEpxNWsped0ylCAx87IYbQORxhKEFHOxRcL9wHbxyC93E0MtBOtI1sToOxF4S-43ohaAvB51QsNTjx3WPHv4AP-AJ0Ck4waBlox_WO8DmUJCJ8UoIe3ceHzrE7umjYdWpA1EKtPkLOKMT-9j3V5PYWeZTweK8E1_sfD0IIQid0g9AdBLB7iQAAvtT_1U-LsySfp1Kz4fIhWCeo9nC-Mhp6wahiE0KVZoPWtTr7ptUxrQ5YHduybMvSGuIJl4qnsSJxlqeVoWNZjXQ9ZVINTC0XrKrXNKd5kjwYmzaRfX4s2O11ur0699X4496id-mtfsr7tYeudvvP8FtW-OU_4Ve8Eb_8HrOGdHpDCiLYlJQwHPvY_dfbaIsW-HiIfewNcAClTh-xXZJig23xMra5AcXr2C5_iW2z91MXn0GxWQED6orgBBDgUWV7jMLQHx8_XQnj2VVn_2EfQwQH0OsjhM9PRo7rgT4-CQ3A3mnrvuhfm1pFH5mmaSKepkyY9UdNj0UmZQvBevV9vbpbr-5AxjR9es-r2fKf7b5Xqm_VqNer1VYcZ6lUgvJU2dDutjs2XLZ7YEK7d4UasilPFBMSdCVy1kI_AgAA__9VjLPE
